<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­å•è¯å‘éŸ³è·Ÿè¯»è®­ç»ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        /* å·¦ä¾§å•è¯å¡ç‰‡åŒºåŸŸ */
        .word-card-container {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .word-info {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .current-word {
            font-size: 4rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .phonetic {
            font-size: 1.5rem;
            color: #666;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .meaning {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 20px;
        }
        
        .example {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            color: #555;
            border-left: 4px solid #667eea;
        }
        
        /* å½•éŸ³æ§åˆ¶åŒºåŸŸ */
        .recording-controls {
            margin: 40px 0;
        }
        
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 160px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(-1px);
        }
        
        /* éŸ³é¢‘å¯è§†åŒ–åŒºåŸŸ */
        .audio-visualization {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .waveform-container {
            height: 150px;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            padding: 10px;
        }
        
        #waveform {
            width: 100%;
            height: 100%;
        }
        
        .recording-indicator {
            text-align: center;
            margin-top: 10px;
        }
        
        .pulse {
            display: inline-block;
            width: 15px;
            height: 15px;
            background: #f44336;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        
        /* è¯„åˆ†åŒºåŸŸ */
        .score-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            margin-top: 30px;
        }
        
        .score-value {
            font-size: 3.5rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }
        
        .score-label {
            font-size: 1.2rem;
            color: #666;
        }
        
        .feedback {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #555;
            font-style: italic;
        }
        
        /* å³ä¾§å•è¯åˆ—è¡¨åŒºåŸŸ */
        .word-list-container {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .word-list-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .word-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .word-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }
        
        .word-item.active {
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            border-left: 4px solid #667eea;
        }
        
        .word-text {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }
        
        .word-score {
            background: #2196F3;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .current-word {
                font-size: 3rem;
            }
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            margin: 30px 0;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ è‹±è¯­å•è¯å‘éŸ³è®­ç»ƒ</h1>
            <p>é€šè¿‡å½•éŸ³è·Ÿè¯»ï¼Œæå‡æ‚¨çš„è‹±è¯­å‘éŸ³å‡†ç¡®åº¦</p>
        </div>
        
        <div class="main-content">
            <!-- å·¦ä¾§å•è¯å¡ç‰‡ -->
            <div class="word-card-container">
                <div class="word-info">
                    <div class="current-word" id="currentWord">Hello</div>
                    <div class="phonetic" id="phonetic">/hÉ™ËˆlÉ™ÊŠ/</div>
                    <div class="meaning" id="meaning">ä½ å¥½ï¼Œå–‚ï¼ˆé—®å€™è¯­ï¼‰</div>
                    <div class="example" id="example">Hello, how are you today?</div>
                </div>
                
                <div class="audio-visualization">
                    <div class="waveform-container">
                        <canvas id="waveform"></canvas>
                    </div>
                    <div class="recording-indicator" id="recordingIndicator" style="display: none;">
                        <div class="pulse"></div>
                        <span style="margin-left: 10px; color: #f44336; font-weight: bold;">æ­£åœ¨å½•éŸ³...</span>
                    </div>
                </div>
                
                <div class="recording-controls">
                    <div class="control-buttons">
                        <button class="btn btn-primary" onclick="playStandard()" id="playBtn">
                            ğŸ”Š å¬æ ‡å‡†å‘éŸ³
                        </button>
                        <button class="btn btn-success" onclick="startRecording()" id="recordBtn">
                            ğŸ¤ å¼€å§‹å½•éŸ³
                        </button>
                        <button class="btn btn-warning" onclick="stopRecording()" id="stopBtn" disabled>
                            â¹ åœæ­¢å½•éŸ³
                        </button>
                        <button class="btn btn-danger" onclick="playComparison()" id="compareBtn" disabled>
                            ğŸ”„ å¯¹æ¯”å‘éŸ³
                        </button>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div style="text-align: center; margin-top: 10px; color: #666;">
                            å½•éŸ³æ—¶é•¿: <span id="recordingTime">0</span>ç§’
                        </div>
                    </div>
                </div>
                
                <div class="score-display">
                    <div class="score-value" id="scoreValue">0%</div>
                    <div class="score-label">å‘éŸ³åŒ¹é…åº¦</div>
                    <div class="feedback" id="feedback">è¯·å¼€å§‹æ‚¨çš„å½•éŸ³</div>
                </div>
            </div>
            
            <!-- å³ä¾§å•è¯åˆ—è¡¨ -->
            <div class="word-list-container">
                <div class="word-list-title">
                    ğŸ“š å•è¯åˆ—è¡¨
                    <div style="font-size: 1rem; color: #666; margin-top: 5px;">
                        ç‚¹å‡»å•è¯å¼€å§‹ç»ƒä¹ 
                    </div>
                </div>
                
                <div class="word-list" id="wordList">
                    <!-- å•è¯åˆ—è¡¨ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ’¡ ä½¿ç”¨æç¤º</h3>
                    <ul style="color: #666; line-height: 1.8;">
                        <li>1. ç‚¹å‡»"å¬æ ‡å‡†å‘éŸ³"å­¦ä¹ æ­£ç¡®è¯»æ³•</li>
                        <li>2. ç‚¹å‡»"å¼€å§‹å½•éŸ³"è¿›è¡Œè·Ÿè¯»ç»ƒä¹ </li>
                        <li>3. å½•éŸ³åå¯ä»¥å¯¹æ¯”æ‚¨çš„å‘éŸ³</li>
                        <li>4. ç³»ç»Ÿä¼šè‡ªåŠ¨è¯„åˆ†å¹¶ç»™å‡ºå»ºè®®</li>
                        <li>5. ç»¿è‰²ä»£è¡¨å‘éŸ³ä¼˜ç§€ï¼Œçº¢è‰²éœ€è¦æ”¹è¿›</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å•è¯åº“æ•°æ®
        const wordDatabase = [
            {
                word: "Hello",
                phonetic: "/hÉ™ËˆlÉ™ÊŠ/",
                meaning: "ä½ å¥½ï¼Œå–‚ï¼ˆé—®å€™è¯­ï¼‰",
                example: "Hello, how are you today?"
            },
            {
                word: "Beautiful",
                phonetic: "/ËˆbjuËtÉªf(É™)l/",
                meaning: "ç¾ä¸½çš„ï¼Œæ¼‚äº®çš„",
                example: "She has a beautiful voice."
            },
            {
                word: "Pronunciation",
                phonetic: "/prÉ™ËŒnÊŒnsiËˆeÉªÊƒ(É™)n/",
                meaning: "å‘éŸ³ï¼Œè¯»éŸ³",
                example: "Practice your pronunciation daily."
            },
            {
                word: "Difficult",
                phonetic: "/ËˆdÉªfÉªk(É™)lt/",
                meaning: "å›°éš¾çš„ï¼Œè‰°éš¾çš„",
                example: "This word is difficult to pronounce."
            },
            {
                word: "Opportunity",
                phonetic: "/ËŒÉ’pÉ™ËˆtjuËnÉ™ti/",
                meaning: "æœºä¼šï¼Œæ—¶æœº",
                example: "Don't miss this opportunity."
            },
            {
                word: "Communication",
                phonetic: "/kÉ™ËŒmjuËnÉªËˆkeÉªÊƒ(É™)n/",
                meaning: "äº¤æµï¼Œæ²Ÿé€š",
                example: "Good communication is important."
            },
            {
                word: "Wonderful",
                phonetic: "/ËˆwÊŒndÉ™f(É™)l/",
                meaning: "æå¥½çš„ï¼Œç²¾å½©çš„",
                example: "What a wonderful day!"
            },
            {
                word: "Challenge",
                phonetic: "/ËˆtÊƒÃ¦lÉªndÊ’/",
                meaning: "æŒ‘æˆ˜ï¼Œè€ƒéªŒ",
                example: "This is a big challenge for me."
            }
        ];

        // å…¨å±€å˜é‡
        let mediaRecorder = null;
        let audioChunks = [];
        let audioContext = null;
        let analyser = null;
        let isRecording = false;
        let currentWordIndex = 0;
        let recordingStartTime = 0;
        let recordingTimer = null;
        let userScores = {};
        let currentAudioBlob = null;

        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            // åˆå§‹åŒ–å•è¯åˆ—è¡¨
            renderWordList();
            
            // åŠ è½½æœ¬åœ°å­˜å‚¨çš„åˆ†æ•°
            loadScores();
            
            // è®¾ç½®å½“å‰å•è¯
            setCurrentWord(0);
            
            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·ç‚¹å‡»åï¼‰
            initAudioContext();
            
            // åˆå§‹åŒ–æ³¢å½¢æ˜¾ç¤º
            initWaveform();
        }

        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // åˆå§‹åŒ–æ³¢å½¢æ˜¾ç¤º
        function initWaveform() {
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }

        // æ¸²æŸ“å•è¯åˆ—è¡¨
        function renderWordList() {
            const wordListElement = document.getElementById('wordList');
            wordListElement.innerHTML = '';
            
            wordDatabase.forEach((word, index) => {
                const wordItem = document.createElement('div');
                wordItem.className = 'word-item';
                if (index === currentWordIndex) {
                    wordItem.classList.add('active');
                }
                
                const score = userScores[word.word] || 0;
                const scoreColor = getScoreColor(score);
                
                wordItem.innerHTML = `
                    <div class="word-text">${word.word}</div>
                    <div class="word-score" style="background: ${scoreColor}">${score}%</div>
                `;
                
                wordItem.onclick = () => setCurrentWord(index);
                wordListElement.appendChild(wordItem);
            });
        }

        // è®¾ç½®å½“å‰å•è¯
        function setCurrentWord(index) {
            currentWordIndex = index;
            const word = wordDatabase[index];
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('currentWord').textContent = word.word;
            document.getElementById('phonetic').textContent = word.phonetic;
            document.getElementById('meaning').textContent = word.meaning;
            document.getElementById('example').textContent = word.example;
            
            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            const score = userScores[word.word] || 0;
            updateScoreDisplay(score);
            
            // æ›´æ–°å•è¯åˆ—è¡¨é«˜äº®
            renderWordList();
            
            // é‡ç½®å½•éŸ³çŠ¶æ€
            resetRecordingState();
        }

        // æ’­æ”¾æ ‡å‡†å‘éŸ³
        function playStandard() {
            const word = wordDatabase[currentWordIndex].word;
            speakText(word);
            
            // æ·»åŠ æ’­æ”¾åé¦ˆ
            const playBtn = document.getElementById('playBtn');
            const originalText = playBtn.innerHTML;
            playBtn.innerHTML = 'ğŸ”Š æ’­æ”¾ä¸­...';
            playBtn.disabled = true;
            
            setTimeout(() => {
                playBtn.innerHTML = originalText;
                playBtn.disabled = false;
            }, 1500);
        }

        // æ–‡æœ¬è½¬è¯­éŸ³
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                
                // è·å–å¯ç”¨çš„è¯­éŸ³åˆ—è¡¨ï¼Œé€‰æ‹©è‹±è¯­è¯­éŸ³
                const voices = speechSynthesis.getVoices();
                const englishVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && voice.name.includes('Female')
                );
                
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                
                speechSynthesis.speak(utterance);
            } else {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 44100,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                // åˆ›å»ºMediaRecorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                // ç›‘å¬æ•°æ®å¯ç”¨äº‹ä»¶
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                // ç›‘å¬å½•éŸ³åœæ­¢äº‹ä»¶
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    currentAudioBlob = audioBlob;
                    
                    // åœæ­¢è®¡æ—¶å™¨
                    clearInterval(recordingTimer);
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('recordBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('compareBtn').disabled = false;
                    
                    // éšè—å½•éŸ³æŒ‡ç¤ºå™¨
                    document.getElementById('recordingIndicator').style.display = 'none';
                    
                    // åˆ†æå½•éŸ³
                    analyzeRecording(audioBlob);
                };
                
                // å¼€å§‹å½•éŸ³
                mediaRecorder.start(100); // æ¯100msæ”¶é›†ä¸€æ¬¡æ•°æ®
                isRecording = true;
                
                // å¼€å§‹è®¡æ—¶
                recordingStartTime = Date.now();
                startRecordingTimer();
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                // æ˜¾ç¤ºå½•éŸ³æŒ‡ç¤ºå™¨
                document.getElementById('recordingIndicator').style.display = 'block';
                
                // å¼€å§‹ç»˜åˆ¶æ³¢å½¢
                startWaveformVisualization(stream);
                
                console.log('å¼€å§‹å½•éŸ³...');
                
            } catch (error) {
                console.error('å½•éŸ³é”™è¯¯:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // åœæ­¢æ‰€æœ‰è½¨é“
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                // åœæ­¢æ³¢å½¢ç»˜åˆ¶
                stopWaveformVisualization();
            }
        }

        // å¼€å§‹å½•éŸ³è®¡æ—¶å™¨
        function startRecordingTimer() {
            clearInterval(recordingTimer);
            
            recordingTimer = setInterval(() => {
                const elapsedTime = Math.floor((Date.now() - recordingStartTime) / 1000);
                document.getElementById('recordingTime').textContent = elapsedTime;
                
                // æ›´æ–°è¿›åº¦æ¡ï¼ˆæœ€å¤šå½•éŸ³10ç§’ï¼‰
                const progress = Math.min((elapsedTime / 10) * 100, 100);
                document.getElementById('progressFill').style.width = progress + '%';
                
                // è‡ªåŠ¨åœæ­¢ï¼ˆ10ç§’åï¼‰
                if (elapsedTime >= 10) {
                    stopRecording();
                }
            }, 1000);
        }

        // å¼€å§‹æ³¢å½¢å¯è§†åŒ–
        function startWaveformVisualization(stream) {
            initAudioContext();
            
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            
            source.connect(analyser);
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');
            
            let animationId = null;
            
            function drawWaveform() {
                animationId = requestAnimationFrame(drawWaveform);
                
                analyser.getByteTimeDomainData(dataArray);
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#667eea';
                ctx.beginPath();
                
                const sliceWidth = canvas.width * 1.0 / bufferLength;
                let x = 0;
                
                for(let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * canvas.height / 2;
                    
                    if(i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    x += sliceWidth;
                }
                
                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();
            }
            
            drawWaveform();
            
            // ä¿å­˜åŠ¨ç”»IDä»¥ä¾¿åœæ­¢
            window.currentWaveformAnimation = animationId;
        }

        // åœæ­¢æ³¢å½¢å¯è§†åŒ–
        function stopWaveformVisualization() {
            if (window.currentWaveformAnimation) {
                cancelAnimationFrame(window.currentWaveformAnimation);
                window.currentWaveformAnimation = null;
            }
            
            // æ¸…ç©ºç”»å¸ƒ
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // åˆ†æå½•éŸ³
        async function analyzeRecording(audioBlob) {
            try {
                // æ¨¡æ‹Ÿåˆ†æè¿‡ç¨‹ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦è°ƒç”¨è¯­éŸ³è¯†åˆ«APIï¼‰
                showLoading(true);
                
                // ä½¿ç”¨ç®€å•çš„ç®—æ³•æ¨¡æ‹Ÿè¯„åˆ†
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const score = calculateMockScore();
                const currentWord = wordDatabase[currentWordIndex].word;
                
                // ä¿å­˜åˆ†æ•°
                userScores[currentWord] = score;
                saveScores();
                
                // æ›´æ–°æ˜¾ç¤º
                updateScoreDisplay(score);
                renderWordList();
                
                showLoading(false);
                
            } catch (error) {
                console.error('åˆ†æé”™è¯¯:', error);
                showLoading(false);
            }
        }

        // è®¡ç®—æ¨¡æ‹Ÿåˆ†æ•°
        function calculateMockScore() {
            // æ¨¡æ‹ŸåŸºäºå½•éŸ³æ—¶é•¿çš„åˆ†æ•°è®¡ç®—
            const recordingTime = parseInt(document.getElementById('recordingTime').textContent);
            
            // åŸºç¡€åˆ†
            let score = 50;
            
            // æ ¹æ®å½•éŸ³æ—¶é•¿è°ƒæ•´
            if (recordingTime < 2) {
                score -= 20; // å½•éŸ³å¤ªçŸ­
            } else if (recordingTime > 8) {
                score += 10; // å½•éŸ³å……åˆ†
            }
            
            // æ·»åŠ éšæœºå˜åŒ–ï¼ˆæ¨¡æ‹Ÿä¸åŒå‘éŸ³è´¨é‡ï¼‰
            const randomVariation = Math.floor(Math.random() * 20) - 5;
            score += randomVariation;
            
            // ç¡®ä¿åˆ†æ•°åœ¨0-100ä¹‹é—´
            score = Math.max(0, Math.min(100, score));
            
            return Math.round(score);
        }

        // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
        function updateScoreDisplay(score) {
            const scoreValueElement = document.getElementById('scoreValue');
            const feedbackElement = document.getElementById('feedback');
            
            scoreValueElement.textContent = score + '%';
            
            // æ ¹æ®åˆ†æ•°è®¾ç½®é¢œè‰²
            let color;
            if (score >= 90) {
                color = '#4CAF50';
                feedbackElement.textContent = 'ğŸ‰ å¤ªæ£’äº†ï¼å‘éŸ³éå¸¸æ ‡å‡†ï¼';
            } else if (score >= 75) {
                color = '#8BC34A';
                feedbackElement.textContent = 'ğŸ‘ å¾ˆä¸é”™ï¼ç»§ç»­ä¿æŒï¼';
            } else if (score >= 60) {
                color = '#FFC107';
                feedbackElement.textContent = 'âš ï¸ è¿˜å¯ä»¥ï¼Œå»ºè®®å¤šç»ƒä¹ å‡ æ¬¡';
            } else if (score >= 40) {
                color = '#FF9800';
                feedbackElement.textContent = 'ğŸ“ éœ€è¦æ›´å¤šç»ƒä¹ ï¼Œæ³¨æ„å‘éŸ³ç»†èŠ‚';
            } else {
                color = '#f44336';
                feedbackElement.textContent = 'ğŸ’¡ å»ºè®®å…ˆä»”ç»†å¬æ ‡å‡†å‘éŸ³ï¼Œå†è·Ÿè¯»ç»ƒä¹ ';
            }
            
            scoreValueElement.style.color = color;
        }

        // æ’­æ”¾å¯¹æ¯”
        function playComparison() {
            if (currentAudioBlob) {
                // å…ˆæ’­æ”¾æ ‡å‡†å‘éŸ³
                playStandard();
                
                // å»¶è¿Ÿæ’­æ”¾ç”¨æˆ·å½•éŸ³
                setTimeout(() => {
                    const audioUrl = URL.createObjectURL(currentAudioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    
                    // æ¸…ç†URL
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                    };
                }, 1500);
            }
        }

        // æ ¹æ®åˆ†æ•°è·å–é¢œè‰²
        function getScoreColor(score) {
            if (score >= 90) return '#4CAF50';
            if (score >= 75) return '#8BC34A';
            if (score >= 60) return '#FFC107';
            if (score >= 40) return '#FF9800';
            return '#f44336';
        }

        // ä¿å­˜åˆ†æ•°åˆ°æœ¬åœ°å­˜å‚¨
        function saveScores() {
            localStorage.setItem('pronunciationScores', JSON.stringify(userScores));
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½åˆ†æ•°
        function loadScores() {
            const savedScores = localStorage.getItem('pronunciationScores');
            if (savedScores) {
                userScores = JSON.parse(savedScores);
            }
        }

        // é‡ç½®å½•éŸ³çŠ¶æ€
        function resetRecordingState() {
            document.getElementById('recordingTime').textContent = '0';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('recordBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('compareBtn').disabled = true;
            document.getElementById('recordingIndicator').style.display = 'none';
            
            currentAudioBlob = null;
            
            // æ¸…é™¤æ³¢å½¢
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show) {
            // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ åŠ è½½åŠ¨ç”»
            if (show) {
                document.getElementById('feedback').textContent = 'æ­£åœ¨åˆ†ææ‚¨çš„å‘éŸ³...';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initPage);

        // ç¡®ä¿è¯­éŸ³åˆæˆå‡†å¤‡å¥½
        if (speechSynthesis.getVoices().length === 0) {
            speechSynthesis.addEventListener('voiceschanged', () => {
                // è¯­éŸ³åˆ—è¡¨å·²åŠ è½½
            });
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜æ³¢å½¢
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('waveform');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        });

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            // ç©ºæ ¼é”®ï¼šå¼€å§‹/åœæ­¢å½•éŸ³
            if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }
            
            // å·¦å³ç®­å¤´ï¼šåˆ‡æ¢å•è¯
            if (e.code === 'ArrowRight') {
                e.preventDefault();
                const nextIndex = (currentWordIndex + 1) % wordDatabase.length;
                setCurrentWord(nextIndex);
            }
            
            if (e.code === 'ArrowLeft') {
                e.preventDefault();
                const prevIndex = (currentWordIndex - 1 + wordDatabase.length) % wordDatabase.length;
                setCurrentWord(prevIndex);
            }
        });

        // æ·»åŠ è¯­éŸ³åˆæˆé”™è¯¯å¤„ç†
        if ('speechSynthesis' in window) {
            speechSynthesis.onerror = (event) => {
                console.error('è¯­éŸ³åˆæˆé”™è¯¯:', event);
                alert('è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
            };
        }
    </script>
</body>
</html>